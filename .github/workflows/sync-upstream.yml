name: Sync with upstream hls.js

on:
  schedule:
    # Каждые 6 часов
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/video-dev/hls.js.git || true
          git fetch upstream --tags

      - name: Check for new upstream release
        id: check
        run: |
          # Получить последний тег upstream (релиз hls.js)
          LATEST_UPSTREAM_TAG=$(git tag -l --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)

          # Получить upstream версию
          git fetch upstream --tags
          UPSTREAM_TAGS=$(git ls-remote --tags upstream | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -1)
          echo "Latest upstream release: $UPSTREAM_TAGS"

          # Проверить, есть ли у нас уже failback версия для этого релиза
          if git tag | grep -q "${UPSTREAM_TAGS}-failback"; then
            echo "Already have failback for $UPSTREAM_TAGS"
            echo "new_release=false" >> $GITHUB_OUTPUT
          else
            echo "New upstream release found: $UPSTREAM_TAGS"
            echo "new_release=true" >> $GITHUB_OUTPUT
            echo "upstream_tag=$UPSTREAM_TAGS" >> $GITHUB_OUTPUT
          fi

          # Также проверить новые коммиты
          UPSTREAM_COMMITS=$(git rev-list HEAD..upstream/master --count 2>/dev/null || echo "0")
          echo "upstream_commits=$UPSTREAM_COMMITS" >> $GITHUB_OUTPUT
          echo "Found $UPSTREAM_COMMITS new commits from upstream"

      - name: Merge upstream changes
        if: steps.check.outputs.upstream_commits != '0'
        id: merge
        run: |
          git checkout master
          if git merge upstream/master --no-edit -m "Merge upstream hls.js changes"; then
            echo "merge_success=true" >> $GITHUB_OUTPUT
          else
            echo "merge_success=false" >> $GITHUB_OUTPUT
            git merge --abort || true
          fi

      - name: Get upstream version and create new version
        if: steps.check.outputs.upstream_commits != '0' && steps.merge.outputs.merge_success == 'true'
        id: version
        run: |
          # Получить версию из upstream package.json
          UPSTREAM_VERSION=$(git show upstream/master:package.json | node -pe "JSON.parse(require('fs').readFileSync('/dev/stdin').toString()).version")
          echo "Upstream version: $UPSTREAM_VERSION"

          # Найти следующий failback номер для этой версии
          FAILBACK_NUM=1
          while git tag | grep -q "v${UPSTREAM_VERSION}-failback.${FAILBACK_NUM}"; do
            FAILBACK_NUM=$((FAILBACK_NUM + 1))
          done

          NEW_VERSION="${UPSTREAM_VERSION}-failback.${FAILBACK_NUM}"
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update package.json version
        if: steps.version.outputs.new_version != ''
        run: |
          # Обновить версию в package.json
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json'));
            pkg.version = '${{ steps.version.outputs.new_version }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          # Обновить package-lock.json
          npm install --package-lock-only || true

          git add package.json package-lock.json
          git commit -m "Auto-sync with upstream and auto-publish new versions"

      - name: Push changes and create tag
        if: steps.version.outputs.new_version != ''
        run: |
          git push origin master
          git tag "v${{ steps.version.outputs.new_version }}"
          git push origin "v${{ steps.version.outputs.new_version }}"

      - name: Create issue on conflict
        if: steps.check.outputs.upstream_commits != '0' && steps.merge.outputs.merge_success == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Merge conflict with upstream hls.js',
              body: 'Automatic sync with upstream hls.js failed due to merge conflicts. Please resolve manually.\n\nUpstream: https://github.com/video-dev/hls.js',
              labels: ['merge-conflict', 'upstream-sync']
            })

      - name: Summary
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Upstream commits: ${{ steps.check.outputs.upstream_commits }}" >> $GITHUB_STEP_SUMMARY
          echo "- New release: ${{ steps.check.outputs.new_release }}" >> $GITHUB_STEP_SUMMARY
          echo "- Merge success: ${{ steps.merge.outputs.merge_success || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- New version: ${{ steps.version.outputs.new_version || 'none' }}" >> $GITHUB_STEP_SUMMARY
